name: Deploy

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+

jobs:
  version:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short-sha: ${{ steps.version.outputs.short-sha }}
      go-ldflags: ${{ steps.version.outputs.go-ldflags }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true
          persist-credentials: false
      - uses: actions/setup-go@v5
        with:
          go-version-file: ./go.mod
          cache: false
      - name: get version numbers
        id: version
        run: |
          echo "short-sha=$(echo ${{ github.sha }} | cut -c 1-7)" >> $GITHUB_OUTPUT
          echo "version=$(go run ./scripts/version.go)" >> $GITHUB_OUTPUT
          echo "go-ldflags=$(go run ./scripts/version.go -g)" >> $GITHUB_OUTPUT
      - name: print version outputs
        run: |
          echo "version: ${{ steps.version.outputs.version }}"
          echo "short-sha: ${{ steps.version.outputs.short-sha }}"
          echo "go-ldflags: ${{ steps.version.outputs.go-ldflags }}"
